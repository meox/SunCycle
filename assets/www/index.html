<!DOCTYPE html>

<html>
  <head>
    <title>SunCycle</title>
    
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="css/black.css" />
    <link rel="stylesheet" href="css/jquery.mobile.structure-1.0.min.css" />
    <link rel="stylesheet" href="css/jquery.mobile.datebox.css" />
    <link href="css/style.css" rel="stylesheet" type="text/css"/>

    <script src="phonegap-1.3.0.js" charset="utf-8"></script>
    <script src="jquery-1.6.4.min.js" charset="utf-8"></script>
    <script src="jquery.mobile-1.0.min.js" charset="utf-8"></script>
    <script src="jquery.mobile.datebox.min.js" charset="utf-8"></script>
    <script src="core.js" charset="utf-8"></script>

    <script>
      var reload_timer = {};
      var lw = 11.09845; // longitude west: W is positive, E is negative
      var Phi = 43.51321; // North latitude: N is positive, S is negative
      var orig_lw = lw, orig_Phi = Phi;

      document.addEventListener("deviceready", onDeviceReady, false);

      function manageGPS() {
	navigator.geolocation.getCurrentPosition(function(pos){
	  // success
	  lw = pos.coords.longitude;
	  Phi = pos.coords.latitude;
	  $(".long").removeClass("dato_error").text(lw);
	  $(".lat").removeClass("dato_error").text(Phi);
	  calculate_sun();
	  setTimeout(manageGPS, 60000);
	},
	function() {
	  // error  
	  $(".long").addClass("dato_error").removeClass("dato").text(lw);
	  $(".lat").addClass("dato_error").removeClass("dato").text(Phi);
	  setTimeout(manageGPS, 60000);
	});
      }

      function onDeviceReady() {
	manageGPS();
      }

      var fixgeometry = function() {
	/* Some orientation changes leave the scroll position at something
	  * that isn't 0,0. This is annoying for user experience. */
	scroll(0, 0);

	/* Calculate the geometry that our content area should take */
	var content = $("#content");
	var header = $("#header");
	//var footer = $("footer:visible");
	var viewport_height = $(window).height();
	var content_height = viewport_height - header.outerHeight();// - footer.outerHeight();

	/* Trim margin/border/padding height */
	content_height -= (content.outerHeight() - content.height()) + 10;
	content.css("min-height", content_height);
	$("body").css("background-size", content.outerWidth()+"px " + viewport_height + "px");
      };

      $(document).ready(function(){
	fixgeometry();
	$(window).resize(fixgeometry);
	updateTime();
	calculate_sun();
      });
    
    </script>
  <head>
  
  <body>
    <div id="home" data-role="page" data-theme="a">
      <div data-role="header" data-position="fixed">
	<h1 id="headerpage">SunCycle</h1>
	<a href="#" data-icon="refresh" class="ui-btn-right" data-iconpos="notext" onclick="calculate_sun();">Update</a>
      </div>
      <div data-role="content">
	<table border="0px" style="border: 0px; margin: auto;">
	  <tr class="row_active">
	    <td class="stitle">DateTime:</td><td><span class="dato" id="cd"></span><br /><span class="dato" id="ctime"></span></td>
	  </tr>

	  <tr><td colspan="2">&nbsp;</td></tr>

	  <tr class="row_active">
	    <td class="stitle">SunRise:</td><td><span class="dato" id="jrise"></span><span class="dato_yellow" id="to_rise"></span></td>
	  </tr>
	  <tr class="row_active">
	    <td class="stitle">SunSet:</td><td><span class="dato" id="jset"></span><span class="dato_yellow" id="to_set"></span></td>
	  </tr>
	  <tr class="row_active">
	    <td class="stitle">Solar noon:</td><td><span class="dato" id="jtransit"></span></td>
	  </tr>

	  <tr><td colspan="2">&nbsp;</td></tr>

	  <tr class="row_active">
	    <td class="stitle">Tomorrow SunRise:</td><td><span class="dato" id="next_jrise"></span></td>
	  </tr>
	  <tr class="row_active">
	    <td class="stitle">Tomorrow SunSet:</td><td><span class="dato" id="next_jset"></span></td>
	  </tr>

	  <tr><td colspan="2">&nbsp;</td></tr>

	  <tr class="row_active">
	    <td class="stitle">Longitude:</td><td><span class="dato" class="long"></span></td>
	  </tr>
	  <tr class="row_active">
	    <td class="stitle">Latitude:</td><td><span class="dato" class="lat"></span></td>
	  </tr>

	</table>
	<br />
	<a href="#choosedate" data-role="button">Change Date</a>
      </div>
    </div>

    <div id="choosedate" data-role="page" data-theme="a" data-add-back-btn="true">
      <div data-role="header" data-position="fixed">
	<h1 id="headerpage">SunCycle</h1>
	<a href="#" data-icon="refresh" class="ui-btn-right" data-iconpos="notext" onclick="calculate_sun();">Update</a>
      </div>
      <div data-role="content">
	<table border="0px" style="border: 0px; margin: auto; width: 100%;">
	  <tr class="row_active">
	    <td colspan="2" style="text-align: center;">
	      <input name="seldate" id="seldate" type="date" data-role="datebox" data-options='{"mode": "flipbox", "theme" : "a", "pickPageFlipButtonTheme" : "a", "forceInheritTheme" : true}'>
	    </td>
	  </tr>

	  <tr><td colspan="2">&nbsp;</td></tr>

	  <tr class="row_active">
	    <td class="stitle">SunRise:</td><td><span class="dato" id="choosedate_jrise">&nbsp;</span></td>
	  </tr>
	  <tr class="row_active">
	    <td class="stitle">SunSet:</td><td><span class="dato" id="choosedate_jset">&nbsp;</span></td>
	  </tr>
	  <tr class="row_active">
	    <td class="stitle">Solar noon:</td><td><span class="dato" id="choosedate_jtransit"></span></td>
	  </tr>

	  <tr><td colspan="2">&nbsp;</td></tr>

	  <tr class="row_active">
	    <td class="stitle">Longitude:</td><td><span class="dato" class="long">&nbsp;</span></td>
	  </tr>
	  <tr class="row_active">
	    <td class="stitle">Latitude:</td><td><span class="dato" class="lat">&nbsp;</span></td>
	  </tr>
	</table>
      </div>
    </div>

    <script>
      $('#seldate').live('datebox', function (e, passed) {
	if(passed.method === 'set')
	{
	  var sd = $('#seldate').val().split('-');
	  var nd = new Date(sd[0], sd[1]-1, sd[2], 0, 0, 0);
	  calculate_sun("choosedate", nd);
	}
      });

      $('#choosedate').live('pageshow', function(){
	  var sd = $('#seldate').val().split('-');
	  console.log(sd.length );
	  if(sd.length !== 3)
	  {
	    var dd = new Date();
	    calculate_sun("choosedate", dd);
	  }
      });

    </script>
  </body>
</html>
