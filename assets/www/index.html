<!DOCTYPE html>

<html>
  <head>
    <title>SunCycle</title>
    
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="css/black.css" />
    <link rel="stylesheet" href="css/jquery.mobile.structure-1.0.min.css" />
    <link rel="stylesheet" href="css/jquery.mobile.datebox.css" />
    <link href="css/style.css" rel="stylesheet" type="text/css"/>

    <script src="phonegap-1.3.0.js" charset="utf-8"></script>
    <script src="jquery-1.6.4.min.js" charset="utf-8"></script>
    <script type="text/javascript" charset="utf-8" src="globalization.js"></script>
    <script src="multilingua.js" charset="utf-8"></script>
    <script src="core.js" charset="utf-8"></script>

    <script>
      var language = 'en';
      var reload_timer = {};
      var lw = 11.09845; // longitude west: W is positive, E is negative
      var Phi = 43.51321; // North latitude: N is positive, S is negative
      var orig_lw = lw, orig_Phi = Phi;

      document.addEventListener("deviceready", onDeviceReady, false);

      function manageGPS(autocall) {
	navigator.geolocation.getCurrentPosition(function(pos){
	  // success
	  lw = pos.coords.longitude;
	  Phi = pos.coords.latitude;
	  $("span.long").addClass("dato").removeClass("dato_error").text(lw);
	  $("span.lat").addClass("dato").removeClass("dato_error").text(Phi);
	  calculate_sun();

	  if(autocall === true) { setTimeout(function(){ manageGPS(true); }, 60000); }
	},
	function() {
	  // error  
	  $("span.long").addClass("dato_error").removeClass("dato").text(lw);
	  $("span.lat").addClass("dato_error").removeClass("dato").text(Phi);

	  if(autocall === true) { setTimeout(function(){ manageGPS(true); }, 60000); }
	});
      }

      function onDeviceReady()
      {
	window.plugins.globalization.getLocaleName(
	  function (locale) {
	    language = locale.value.split("_")[0];
	    console.log("Selection language: " + language);
	    if(language === 'it')
	    {
	      $("#datetime").text(Language[language].datetime);
	      $("td.title_sunrise").text(Language[language].sunrise);
	      $("td.title_sunset").text(Language[language].sunset);
	      $("td.title_solar").text(Language[language].solar_noon);
	      $("#title_nextsunrise").text(Language[language].tomorrow_sunrise);
	      $("#title_nextsunset").text(Language[language].tomorrow_sunset);
	      $("td.title_long").text(Language[language].longitude);
	      $("td.title_lat").text(Language[language].latitude);
	      $("#btn_choosedate .ui-btn-text").text(Language[language].select_date);
	    }
	  },
	  function () {}
	);

	manageGPS();
	/*document.addEventListener("menubutton", function(){
	  $.mobile.changePage("#menu", {
	    transition: "pop",
	  });
	}, false);*/
      }

      function updateData()
      {
	manageGPS(false);
	return false;
      }

      var fixgeometry = function() {
	/* Some orientation changes leave the scroll position at something
	  * that isn't 0,0. This is annoying for user experience. */
	scroll(0, 0);

	/* Calculate the geometry that our content area should take */
	var content = $("#content");
	var header = $("[data-role=header]");
	//var footer = $("footer:visible");
	var viewport_height = $(window).height();
	var content_height = viewport_height - header.outerHeight();

	/* Trim margin/border/padding height */
	content_height -= (content.outerHeight() - content.height()) + 10;
	content.css("min-height", content_height);
	$("body").css("background-size", content.outerWidth()+"px " + viewport_height + "px");
      };

      $(document).ready(function(){
	//fixgeometry();
	//$(window).resize(fixgeometry);
	updateTime();
	calculate_sun();
	setInterval(calculate_sun, 30000);
      });

    </script>
    <script src="jquery.mobile-1.0.min.js" charset="utf-8"></script>
    <script src="jquery.mobile.datebox.min.js" charset="utf-8"></script>
  <head>
  
  <body>
    <div id="home" data-role="page" data-theme="a">
      <div data-role="header" data-position="fixed">
	<h1 id="headerpage">SunCycle</h1>
	<a href="#" data-icon="refresh" class="ui-btn-right" data-iconpos="notext" onclick="updateData();">Update</a>
      </div>
      <div data-role="content">
	<table border="0px" style="border: 0px; margin: auto;">
	  <tr class="row_active">
	    <td id="datetime" class="stitle">DateTime:</td><td><span class="dato" id="cd"></span><br /><span class="dato" id="ctime"></span></td>
	  </tr>

	  <tr><td colspan="2">&nbsp;</td></tr>

	  <tr class="row_active">
	    <td class="stitle title_sunrise">SunRise:</td><td><span class="dato" id="jrise"></span><span class="dato_yellow" id="to_rise"></span></td>
	  </tr>
	  <tr class="row_active">
	    <td class="stitle title_sunset">SunSet:</td><td><span class="dato" id="jset"></span><span class="dato_yellow" id="to_set"></span></td>
	  </tr>
	  <tr class="row_active">
	    <td class="stitle title_solar">Solar noon:</td><td><span class="dato" id="jtransit"></span></td>
	  </tr>

	  <tr><td colspan="2">&nbsp;</td></tr>

	  <tr class="row_active">
	    <td id="title_nextsunrise" class="stitle">Tomorrow SunRise:</td><td><span class="dato" id="next_jrise"></span></td>
	  </tr>
	  <tr class="row_active">
	    <td id="title_nextsunset" class="stitle">Tomorrow SunSet:</td><td><span class="dato" id="next_jset"></span></td>
	  </tr>

	  <tr><td colspan="2">&nbsp;</td></tr>

	  <tr class="row_active">
	    <td class="stitle title_long">Longitude:</td><td><span class="dato long"></span></td>
	  </tr>
	  <tr class="row_active">
	    <td class="stitle title_lat">Latitude:</td><td><span class="dato lat"></span></td>
	  </tr>

	</table>
	<br />
	<a id="btn_choosedate" href="#choosedate" data-role="button">Change Date</a>
      </div>
    </div>

    <div id="choosedate" data-role="page" data-theme="a" data-add-back-btn="true">
      <div data-role="header" data-position="fixed">
	<h1 id="headerpage">SunCycle</h1>
	<a href="#" data-icon="refresh" class="ui-btn-right" data-iconpos="notext" onclick="calculate_sun();">Update</a>
      </div>
      <div data-role="content">
	<table border="0px" style="border: 0px; margin: auto; width: 100%;">
	  <tr class="row_active">
	    <td colspan="2" style="text-align: center;">
	      <input name="seldate" id="seldate" type="date" data-role="datebox" data-options='{"mode": "flipbox", "theme" : "a", "pickPageFlipButtonTheme" : "a", "forceInheritTheme" : true}'>
	    </td>
	  </tr>

	  <tr><td colspan="2">&nbsp;</td></tr>

	  <tr class="row_active">
	    <td class="stitle title_sunrise">SunRise:</td><td><span class="dato" id="choosedate_jrise">&nbsp;</span></td>
	  </tr>
	  <tr class="row_active">
	    <td class="stitle title_sunset">SunSet:</td><td><span class="dato" id="choosedate_jset">&nbsp;</span></td>
	  </tr>
	  <tr class="row_active">
	    <td class="stitle title_solar">Solar noon:</td><td><span class="dato" id="choosedate_jtransit"></span></td>
	  </tr>

	  <tr><td colspan="2">&nbsp;</td></tr>

	  <tr class="row_active">
	    <td class="stitle title_long">Longitude:</td><td><span class="dato long">&nbsp;</span></td>
	  </tr>
	  <tr class="row_active">
	    <td class="stitle title_lat">Latitude:</td><td><span class="dato lat">&nbsp;</span></td>
	  </tr>
	</table>
      </div>
    </div>

    <div id="menu" data-role="dialog" data-theme="a">
      <div data-role="header" data-position="fixed">
	<h1 id="headerpage">Men&ugrave;</h1>
      </div>
      <div data-role="content">
	<br /><br />
	<ul data-role="listview">
	  <li data-role="fieldcontain">
	    <label for="slider_alarm">Alarm:</label>
	    <select name="slider_alarm" id="slider_alarm" data-role="slider">
	      <option value="off">Off</option>
	      <option value="on">On</option>
	    </select> 
	  </li>
	  <li data-role="fieldcontain">
	    <fieldset data-role="controlgroup">
		<legend>Alert time:</legend>
		<input type="radio" name="choice-time-alarm" id="choice-time-alarm-1" value="5" checked="checked" />
		<label for="choice-time-alarm-1">5 min</label>
		<input type="radio" name="choice-time-alarm" id="choice-time-alarm-2" value="10" />
		<label for="choice-time-alarm-2">10 min</label>
		<input type="radio" name="choice-time-alarm" id="choice-time-alarm-3" value="20" />
		<label for="choice-time-alarm-3">20 min</label>
	    </fieldset>
	  </li>
	  <li class="ui-body">
	    <fieldset class="ui-grid-a">
	      <div class="ui-block-a"><button type="submit" onclick="$(this).dialog('close');">Cancel</button></div>
	      <div class="ui-block-b"><button type="submit">Save</button></div>
	    </fieldset>
	  </li>
	</ul>
      </div>
    </div>

    <script>
      $('#seldate').live('datebox', function (e, passed) {
	if(passed.method === 'set')
	{
	  var sd = $('#seldate').val().split('-');
	  var nd = new Date(sd[0], sd[1]-1, sd[2], 0, 0, 0);
	  calculate_sun("choosedate", nd);
	}
      });

      $('#choosedate').live('pageshow', function(){
	  var sd = $('#seldate').val().split('-');
	  console.log(sd.length );
	  if(sd.length !== 3)
	  {
	    var dd = new Date();
	    calculate_sun("choosedate", dd);
	  }
      });

    </script>
  </body>
</html>
